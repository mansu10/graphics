<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script type="text/javascript" src="jquery-1.11.1.min.js"></script>
	<style type="text/css">
	.draw-target {
		width: 480px;
		height: 320px;
		margin-bottom: 5px;
		margin-right: 5px;
		background-color: #ccf;
		position: relative;
		float: left;
	}
	</style>
	<script type="text/javascript">
	(function($){
		$.fn.bouncyPlugin = function(option){
			var DHTMLSprite = function(params){
				var width = params.width,
					height = params.height,
					imagesWidth = params.imagesWidth,
					$element = params.$drawTarget.append('<div/>').find(':last'),
					elemStyle = $element[0].style,
					mathFloor = Math.floor;

				$element.css({
					position: 'absolute',
					width: width,
					height: height,
					backgroundImage: 'url('+params.images+')'
				});
				var that = {
					draw: function(x, y){
						elemStyle.left = x + 'px';
						elemStyle.top = y + 'px';
					},
					changeImage: function(index){
						index *= width;
						var vOffset = -mathFloor(index / imagesWidth) * height;
						var hOffset = -index % imagesWidth;
						elemStyle.backgroundPosition = hOffset + 'px ' + vOffset + 'px';
					},
					show: function(){
						elemStyle.display = 'block';
					},
					hide: function(){
						elemStyle.display = 'none';
					},
					destroy: function(){
						$element.remove();
					}
				}
				return that;
			}
			var bouncySprite = function(params){
				var x = params.x,
					y = params.y,
					xDir = params.xDir,
					yDir = params.yDir,
					maxX = params.maxX,
					maxY = params.maxY,
					animIndex = 0,
					that = DHTMLSprite(params);

				that.moveAndDraw = function(tCoeff){
					x += xDir * tCoeff;
					y += yDir * tCoeff;
					animIndex += xDir > 0 ? 1 * tCoeff : -1 * tCoeff;
					var animIndex2 = (animIndex % 5) >> 0;

					animIndex2 += animIndex2 < 0 ? 5 : 0;

					if ((xDir < 0 && x < 0) || (xDir > 0 && x >= maxX)) {
						xDir = -xDir;
					};
					if ((yDir < 0 && y < 0) || (yDir > 0 && y >= maxY)) {
						yDir = -yDir;
					};
					that.changeImage(animIndex2);
					that.draw(x, y);
				}
				

				return that;
			}
			var bouncyBoss = function(numBouncy, $drawTarget){
				var bouncys = [];
				var timer = timeInfo(40);
				for (var i = 0; i < numBouncy; i++) {
					bouncys.push(bouncySprite({
						images: 'sprite.png',
						imagesWidth: 256,
						width: 64,
						height: 64,
						$drawTarget: $drawTarget,
						x: Math.random() * ($drawTarget.width() - 64),
						y: Math.random() * ($drawTarget.height() - 64),
						xDir: Math.random() * 4 - 2,
						yDir: Math.random() * 4 - 2,
						maxX: $drawTarget.width() - 64,
						maxY: $drawTarget.height() - 64
					}));
				};
				var moveAll = function(){
					var timeData = timer.getInfo();
					var len = bouncys.length;
					for (var i = 0; i < len; i++) {
						bouncys[i].moveAndDraw(timeData.coeff);
					};
					setTimeout(moveAll, 10);
				}
				moveAll();
			}
			var timeInfo = function(goalFPS){
			var oldTime, paused = true,
				interCount = 0,
				totalFPS = 0,
				totalCoeff = 0;
				return {
					getInfo: function(){
						if (paused === true) {
							paused = false;
							oldTime = +new Date();//+new Date() 等价于 new Date().getTime()
							return {
								elapsed: 0,
								coeff: 0,
								FPS: 0,
								averageFPS: 0,
								averageCoeff: 0
							}
						};
						var newTime = +new Date();
						var elapsed = newTime - oldTime;
						oldTime = newTime;
						var FPS = 1000/elapsed;
						interCount++;
						totalFPS += FPS;
						var coeff = goalFPS / FPS;
						totalCoeff += coeff;
						return {
							elapsed: elapsed,
							coeff: goalFPS / FPS,
							FPS: FPS,
							averageFPS: totalFPS / interCount,
							averageCoeff: totalCoeff / interCount
						}
					}
					// pause: function(){
					// 	paused = true;
					// }
				}
			}
			return this.each(function(){
				var $drawTarget = $(this);
				$drawTarget.css('background-color', option.bgColor);
				bouncyBoss(option.numBouncy, $drawTarget);
			})
		}
		$.fn.bouncyPlugin.defaults = {
			bgColor: '#f00',
			numBouncy: 10
		}
	})(jQuery);



	$(document).ready(function() {

		//var sprite1 = DHTMLSprite(params);
		// var sprite2 = DHTMLSprite(params);
		// sprite2.changeImage(2);

		// bouncyBoss(5, $('#draw-target'));
		$('.draw-target').bouncyPlugin({
			numBouncy: 10,
			bgColor: '#ff9'
		})
	});
	</script>
</head>
<body>
<div class="draw-target"></div>
<div class="draw-target"></div>
<div class="draw-target"></div>
<div class="draw-target"></div>
</body>
</html>